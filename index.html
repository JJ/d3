<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    
    <title>Tutorial D3.js</title>
    
    <meta name="description" content="Tutorial D3.js para visualización de datos">
    <meta name="author" content="JJ Merelo">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/extra.css">
    <link rel="stylesheet" href="css/theme/solarized.css" id="theme">
    
    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Plotly stuff -->
    <script src="lib/htmlwidgets-0.6/htmlwidgets.js"></script>
    <script src="lib/plotlyjs-1.6.1/plotly-latest.min.js"></script>
    <script src="lib/plotly-binding-3.4.3/plotly.js"></script>
    
    <!-- Printing and PDF exports -->
    <script>
     var link = document.createElement( 'link' );
     link.rel = 'stylesheet';
     link.type = 'text/css';
     link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
     document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>
  
  <body>
    <div id='fija' class='fija'></div>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
	<section>
	  <h1>Visualizando datos con d3.js</h1>
	</section>

	<section>
	  <h1>Biblioteca JavaScript para documentos orientados a datos</h1>

	  <pre><code><script src="https://d3js.org/d3.v3.min.js" charset="utf-8">
</script></code></pre>
	  <aside class='notes'>Las <a href='https://github.com/mbostock/d3/wiki'>instrucciones son bastante precisas en cuanto al charset y demás</a>. También se puede usar el clásico CDN https://cdnjs.com/libraries/d3. Siempre es importante usar o bien versiones online o, mucho mejor CDNs, en vez de versiones descargadas. ¿Por qué se pone el // en vez de http? </aside>
	</section>

	<section>
	  <section>
	    <h1>No todos los gráficos son iguales.</h1>
	    <aside class='notes'>Diferentes tipos de gráficos permiten percibir mejos las cantidades que se están graficando, según <a href='http://flowingdata.com/2010/03/20/graphical-perception-learn-the-fundamentals-first/'>un estudio de los años 80</a></aside>
	  </section>
	  
	  <section>
	    <img src='img/elecciones.png' alt='gráficos de
	    dispersión'>
	    <aside class='notes'>Usando los datos (libres) de las
	    elecciones en <a
	      href='https://github.com/inchocordero/granadaton'>el
	    GranaDaton</a>, vamos a hacer una serie de gráficos
	    interesantes. Los gráficos de dispersión son los
	    más aceptables, porque una de las cantidades que mejor se
	    perciben son las distancias. Los colores en este caso
	    también son claros y los tamaños también se pueden
	      apreciar claramente, combinándolos en un solo gráfico.</aside>
	  </section>

	   <section>
	    <img src='img/elecciones-bar.png' alt='gráficos de
	    barras'>
	    <aside class='notes'>En este caso usamos la percepción del
	    tamaño para el número de votos, la anchura de la barra
	      para la cantidad de partidos presentes en cada una de las elecciones.</aside>
	  </section>

	   <section>
	     <div id='htmlwidget-container'>
	       <div id="htmlwidget-3336" style="width:960px;height:500px;" class="plotly html-widget"></div>
	     </div>
	     <script type="application/json" data-for="htmlwidget-3336" id='this-data'>{"x":{"data":[{"x":[1,2,3,4,7,10,13,16,18,21,23],"y":[18208995,16873318,20947219,20081733,20351887,23403185,24802931,22814451,25483504,25448684,24015425],"text":["votos: 18208995<br>Tipo:  Congreso<br>partidos: 70","votos: 16873318<br>Tipo:  Congreso<br>partidos: 52","votos: 20947219<br>Tipo:  Congreso<br>partidos: 59","votos: 20081733<br>Tipo:  Congreso<br>partidos: 51","votos: 20351887<br>Tipo:  Congreso<br>partidos: 63","votos: 23403185<br>Tipo:  Congreso<br>partidos: 85","votos: 24802931<br>Tipo:  Congreso<br>partidos: 69","votos: 22814451<br>Tipo:  Congreso<br>partidos: 97","votos: 25483504<br>Tipo:  Congreso<br>partidos: 96","votos: 25448684<br>Tipo:  Congreso<br>partidos: 98","votos: 24015425<br>Tipo:  Congreso<br>partidos: 62"],"key":null,"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgb(248,118,109)","opacity":1,"size":[13.7742214553942,11.1917909343566,12.2897027575514,11.0213712947896,12.8576591133593,15.4993450005551,13.6484970305592,16.7148394102067,16.6179443241592,16.8110140567108,12.7190535456617],"symbol":"circle","line":{"width":1.88976377952756,"color":"rgb(248,118,109)"}},"name":" Congreso","legendgroup":" Congreso","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text"},{"x":[5,9,12,14,17,20,24],"y":[19277743,18629339,21817932,20881613,22563069,21553906,21994540],"text":["votos: 19277743<br>Tipo:  Municipales<br>partidos: 117","votos: 18629339<br>Tipo:  Municipales<br>partidos: 173","votos: 21817932<br>Tipo:  Municipales<br>partidos: 163","votos: 20881613<br>Tipo:  Municipales<br>partidos: 30","votos: 22563069<br>Tipo:  Municipales<br>partidos: 31","votos: 21553906<br>Tipo:  Municipales<br>partidos: 30","votos: 21994540<br>Tipo:  Municipales<br>partidos: 40"],"key":null,"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgb(0,186,56)","opacity":1,"size":[18.5195833841632,22.6771653543307,22.0044346293545,3.77952755905512,5.35982742048584,3.77952755905512,8.77687450722468],"symbol":"circle","line":{"width":1.88976377952756,"color":"rgb(0,186,56)"}},"name":" Municipales","legendgroup":" Municipales","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text"},{"x":[6,8,11,15,19,22,25],"y":[19071497,15657676,18364794,20808681,15417268,15615296,15348649],"text":["votos: 19071497<br>Tipo:  Parlamento Europeo<br>partidos: 35","votos: 15657676<br>Tipo:  Parlamento Europeo<br>partidos: 33","votos: 18364794<br>Tipo:  Parlamento Europeo<br>partidos: 35","votos: 20808681<br>Tipo:  Parlamento Europeo<br>partidos: 36","votos: 15417268<br>Tipo:  Parlamento Europeo<br>partidos: 31","votos: 15615296<br>Tipo:  Parlamento Europeo<br>partidos: 35","votos: 15348649<br>Tipo:  Parlamento Europeo<br>partidos: 39"],"key":null,"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgb(97,156,255)","opacity":1,"size":[7.31318547404771,6.51668721024719,7.31318547404771,7.65045586015135,5.35982742048584,7.31318547404771,8.52042714334729],"symbol":"circle","line":{"width":1.88976377952756,"color":"rgb(97,156,255)"}},"name":" Parlamento Europeo","legendgroup":" Parlamento Europeo","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text"}],"layout":{"margin":{"b":177.534246575343,"l":72.3287671232877,"t":23.3059360730594,"r":7.30593607305936},"plot_bgcolor":"rgb(235,235,235)","paper_bgcolor":"rgb(255,255,255)","font":{"color":"rgb(0,0,0)","family":"","size":14.6118721461187},"xaxis":{"type":"linear","autorange":false,"tickmode":"array","range":[0.4,25.6],"ticktext":["1977/6- Congreso","1979/3- Congreso","1982/10- Congreso","1986/6- Congreso","1987/6- Municipales","1987/6- Parlamento Europeo","1989/10- Congreso","1989/6- Parlamento Europeo","1991/5- Municipales","1993/6- Congreso","1994/6- Parlamento Europeo","1995/5- Municipales","1996/3- Congreso","1999/6- Municipales","1999/6- Parlamento Europeo","2000/3- Congreso","2003/5- Municipales","2004/3- Congreso","2004/6- Parlamento Europeo","2007/5- Municipales","2008/3- Congreso","2009/6- Parlamento Europeo","2011/11- Congreso","2011/5- Municipales","2014/5- Parlamento Europeo"],"tickvals":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],"ticks":"outside","tickcolor":"rgb(51,51,51)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgb(77,77,77)","family":"","size":11.689497716895},"tickangle":-90,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"domain":[0,1],"gridcolor":"rgb(255,255,255)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","hoverformat":".2f"},"annotations":[{"text":"Fecha","x":0.5,"y":-0.42490932228188,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgb(0,0,0)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"middle"},{"text":"votos","x":-0.150528414620038,"y":0.5,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgb(0,0,0)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-90,"xanchor":"center","yanchor":"middle"},{"text":"partidos<br>Tipo","x":1.02,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgb(0,0,0)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"left","yanchor":"top"}],"yaxis":{"type":"linear","autorange":false,"tickmode":"array","range":[14841906.25,25990246.75],"ticktext":["15000000","17500000","20000000","22500000","25000000"],"tickvals":[15000000,17500000,20000000,22500000,25000000],"ticks":"outside","tickcolor":"rgb(51,51,51)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgb(77,77,77)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"domain":[0,1],"gridcolor":"rgb(255,255,255)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":true,"legend":{"bgcolor":"rgb(255,255,255)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgb(0,0,0)","family":"","size":11.689497716895},"y":0.876081063637537},"hovermode":"closest"},"source":"A","config":{"modeBarButtonsToRemove":["sendDataToCloud"]},"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>

<script type="application/htmlwidget-sizing" data-for="htmlwidget-3336">{"viewer":{"width":450,"height":350,"padding":5,"fill":true},"browser":{"width":960,"height":500,"padding":5,"fill":true}}</script>

<aside class='notes'>La principal diferencia entre tener el gráfico estático y usar alguna librería como d3.js es esta: añadir algún tipo de interacción. En este caso lo hemos generado automáticamente con Plotly desde el script en R original, así que no hay mucho código que mostrar. En <a href='https://plot.ly/r/'>esta página se ve cómo usarlo</a>. Los mismos principios del gráfico original están presentes en este. Pero intentaremos construirlos desde el principio.</aside>
	   </section>
	</section>

	<section> <!-- Integrar los datos -->
	  
	  <section><h1>Integrar los datos en el script</h1>
	  </section>

	  <section>
	    <pre><code>&lt;script type="application/json" id='this-data'>
{"x":{
  "data":[{"x":[1,2,3,4,7,10,13,16,18,21,23],
  "y":[18208995,16873318,20947219,20081733,20351887,23403185,
       24802931,22814451,25483504,25448684,24015425],
  "text":["votos: 18208995<br>Tipo:  Congreso<br>partidos: 70",...
	    </code></pre>

<pre class='fragment'><code>var my_data_text = document.getElementById("this-data").textContent;
var my_data = JSON.parse(my_data_text);
console.log(my_data)
</code></pre>
<aside class='notes'>En este caso es que tenemos ya los datos en esta
  presentación, incluidos como un script en JSON. JSON es un
  subconjunto de JavaScript para serializar datos que tiene la pinta
  anterior. En este caso es un JSON generado por Plot.ly, junto con el
  resto del script, usando la librería de R en la que teníamos los
  datos originalmente. Para procesarla usamos directamente JS que
  extrae los datos del DOM en forma de texto y los parsea usando la
  biblioteca JSON, que está presente en navegadores y en todos sitios.</aside>
	  </section>
	</section>

	<section> <!-- conceptos fundamentales -->
	  <section>
  <div class='fragment chart' id='bar1'></div>
  <pre><code>    d3.select("#bar1")
    .selectAll("div")
    .data(my_data.x.data[0].y).enter()
    .append("div")
    .style("width", function(d) { console.log(d);return d/50000 + "px"; })
      .text(function(d) { return d; });</code></pre>
  <script>var my_data_text = document.getElementById("this-data").textContent;
    var my_data = JSON.parse(my_data_text);
    console.log(my_data.x.data[0].y);
    d3.select("#bar1")
    .selectAll("div")
    .data(my_data.x.data[0].y).enter()
    .append("div")
    .style("width", function(d) { console.log(d);return d/50000 + "px"; })
    .text(function(d) { return d; });
  </script>
  <aside class='notes'>En este caso vamos a usar nuestro primer código
  D3, para crear un diagrama de barras hecho a base de divs, con
    longitudes que dependen del número de votos.</aside>
	  </section>

	  <section>
	    <pre><code>var bar1 = d3.select("#bar1")</code></pre>
	    <img src='img/bar1.png' alt='captura de pantalla'>
	    <aside class='notes'>select es simplemente un selector que
	    actúa como el selector similar de JQuery. En este caso,
	      capturamos el objeto del DOM sobre el que vamos a
	    trabajar. Más información en <a
	    href='https://github.com/mbostock/d3/wiki/Selections'>el
	      wiki de D3</a>. </aside>
	  </section>

	  <section>
	    <h2>Seleccionando por tipo de elemento</h2>
	    <pre><code>var all_divs = bar1.selectAll("div")</code></pre>
	    <img src='img/divs.png' class='fragment' alt='divs'>
	    <aside class='notes'>En este caso estamos seleccionando
	    nodos inexistentes, pero los vamos a hacer que existan de
	      un momento a otro</aside>
	  </section>
	   
	</section>

	<section><!-- Data joins -->
	  <section><h1>D3 → funcional </h1>
	    <h2>Los <em>data joins</em> declaran qué se quiere hacer
	      con los datos.</h2>
	  </section>
	  
	  <section>
	    <pre><code>var times = time_div.selectAll("div").data(data);</code></pre>
	    <h2 class='fragment'><code>div</code>s no existen...</h2>
	    <h3 class='fragment'>... todavía</h3>
	    <pre class='fragment'><code>times.enter().append("div")
			   .style("width", function(d) { 
			     console.log("ENTER"+d);
			     return d/100 + "px"; 
			   })
			   .text(function(d) { return d; });
	    </code></pre>

	    <aside class='notes'>Se le añade un div y se establece un
	      tamaño que es el que queremos para la barra.</aside>
	  </section>
	  
	  <section><h1>¿Y si ya existen?</h1>
	    <pre class='fragment'><code>times.style("width", function(d) { 
		     console.log("ENTER+UPDATE"+d);
		     return d/100 + "px"; 
		   })
		    	.text(function(d) { return d; });</code></pre>
	    <aside class='notes'>Se actualizan los datos existentes
	      con este código (igual que el anterior).</aside>
	  </section>

	  <section><h1>¿Y si ya se fueron?</h1>
	    <pre
	    class='fragment'><code>times.exit().remove();</code></pre>
	    <aside class='notes'>En este caso, salvo que borremos una
	    diapo sobre la marcha, no la vamos a usar... aunque
	      podemos hacerlo a lo cafre</aside></section>
	</section>
      </div>

      
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>
		<script>
		 var total_time = new Date().getTime();
		 var last_time = total_time;
		 // Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
		 Reveal.initialize({			
							width: 1200,
							height: 800,
							controls: true,
							progress: true,
							history: true,
							center: true,
							
							transition: 'concave', // none/fade/slide/convex/concave/zoom
							
							// Optional reveal.js plugins
							dependencies: [
							  { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
							  { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
							  { src: 'plugin/zoom-js/zoom.js', async: true },
							  { src: 'plugin/notes/notes.js', async: true }
							]
		 });
		 var time_in_slide = new Array;
		 var time_div = d3.select("#fija");
		 var total_slide_time = 0;
		 // Taken from https://bl.ocks.org/mbostock/3808218
		 function update(data) {
		   
		   // DATA JOIN
		   // Join new data with old elements, if any.
		   var times = time_div.selectAll("div").data(data);
		   
		   // ENTER
		   // Create new elements as needed.
	           times.enter().append("div")
			   .style("width", function(d) { 
//			     console.log("ENTER"+d);
			     return d/100 + "px"; 
			   })
			   .text(function(d) { return d; });

		   // ENTER + UPDATE
		   // Appending to the enter selection expands the update selection to include
		   // entering elements; so, operations on the update selection after appending to
		   // the enter selection will apply to both entering and updating nodes.
		   times.style("width", function(d) { 
//		     console.log("ENTER+UPDATE"+d);
		     return d/100 + "px"; 
		   })
		    	.text(function(d) { return d; });

		   // EXIT
		   // Remove old elements as needed.
		   times.exit().remove();
		 }
		 var slide_re = /\#\/(\d+)\/?(\d*)/;
		 Reveal.addEventListener( 'slidechanged'
					  , function( event ) {
					      var this_time = new Date().getTime();
					      var
					      base_URI=event.previousSlide.baseURI;

//		 console.log(event);
		 var slides_result =  slide_re.exec(base_URI);
		 console.log(slides_result);
		 var last_slide;
		 var last_vslide;
		 if ( slides_result !== null ) {
		     last_slide = slides_result[1];
		     if (slides_result.length > 1 ) {
		       last_vslide = slides_result[2];
		     } else {
		       last_vslide = 0;
		     }
		 } else {
		     console.log( base_URI );
		     last_slide = 0;
		 }
		 if ( last_slide === event.indexh ) {
		     total_slide_time += this_time - last_time;
		 } else {
		     total_slide_time = this_time - last_time;
		 }

//					      console.log("Esta "+this_slide);
					      time_in_slide[last_slide]=total_slide_time;
					      last_time = this_time;
					      update( time_in_slide );
					    } );

		</script>

	</body>
</html>
